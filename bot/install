#!/bin/bash
set -e

# ====== إعدادات عامة ======
BOT_DIR="/usr/bin/telegram"
BOT_FILE="bot.py"
BOT_URL="https://github.com/hmz-hh/my-web/raw/refs/heads/main/bot/script"   # 🔗 غيّر الرابط باللي فيه سكريبتك
SERVICE_FILE="/etc/systemd/system/telegram-bot.service"

echo "📦 تحديث النظام وتثبيت المتطلبات..."
apt update -y && apt install -y python3 python3-pip python3-venv curl

# إنشاء مجلد البوت
mkdir -p $BOT_DIR

# تنزيل سكريبت البوت
curl -fsSL "$BOT_URL" -o "$BOT_DIR/$BOT_FILE"

# إنشاء بيئة افتراضية + تثبيت المكتبات
python3 -m venv "$BOT_DIR/venv"
"$BOT_DIR/venv/bin/pip" install --upgrade pip
"$BOT_DIR/venv/bin/pip" install python-telegram-bot==13.15

# إنشاء ملف الخدمة systemd
cat > "$SERVICE_FILE" <<EOF
[Unit]
Description=Telegram Bot Service
After=network.target

[Service]
WorkingDirectory=$BOT_DIR
ExecStart=$BOT_DIR/venv/bin/python3 $BOT_DIR/$BOT_FILE
Restart=always

[Install]
WantedBy=multi-user.target
EOF

# تفعيل وتشغيل الخدمة
systemctl daemon-reload
systemctl enable telegram-bot
systemctl restart telegram-bot

echo "✅ البوت تركب وخدام كـ systemd service (telegram-bot)."
