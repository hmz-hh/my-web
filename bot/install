#!/bin/bash
set -e

# ====== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© ======
BOT_DIR="/usr/bin/telegram"
BOT_FILE="bot.py"
BOT_URL="https://github.com/hmz-hh/my-web/raw/refs/heads/main/bot/script"   # ðŸ”— ØºÙŠÙ‘Ø± Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ø§Ù„Ù„ÙŠ ÙÙŠÙ‡ Ø³ÙƒØ±ÙŠØ¨ØªÙƒ
SERVICE_FILE="/etc/systemd/system/telegram-bot.service"

echo "ðŸ“¦ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª..."
apt update -y && apt install -y python3 python3-pip python3-venv curl

# Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¨ÙˆØª
mkdir -p $BOT_DIR

# ØªÙ†Ø²ÙŠÙ„ Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ø¨ÙˆØª
curl -fsSL "$BOT_URL" -o "$BOT_DIR/$BOT_FILE"

# Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ¦Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© + ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª
python3 -m venv "$BOT_DIR/venv"
"$BOT_DIR/venv/bin/pip" install --upgrade pip
"$BOT_DIR/venv/bin/pip" install python-telegram-bot==13.15

# Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„Ø®Ø¯Ù…Ø© systemd
cat > "$SERVICE_FILE" <<EOF
[Unit]
Description=Telegram Bot Service
After=network.target

[Service]
WorkingDirectory=$BOT_DIR
ExecStart=$BOT_DIR/venv/bin/python3 $BOT_DIR/$BOT_FILE
Restart=always

[Install]
WantedBy=multi-user.target
EOF

# ØªÙØ¹ÙŠÙ„ ÙˆØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©
systemctl daemon-reload
systemctl enable telegram-bot
systemctl restart telegram-bot

echo "âœ… Ø§Ù„Ø¨ÙˆØª ØªØ±ÙƒØ¨ ÙˆØ®Ø¯Ø§Ù… ÙƒÙ€ systemd service (telegram-bot)."
