#!/bin/bash
set -e

# ==== إعدادات عامة ====
BOT_DIR="/usr/bin/telegram"
BOT_FILE="bot.py"
BOT_URL="https://yourdomain.com/path/to/bot.py"   # 🔴 حط هنا الرابط ديال السكريبت ديالك
SERVICE_FILE="/etc/systemd/system/telegram-bot.service"

echo "📦 Installing dependencies..."
sudo apt update -y && sudo apt upgrade -y
sudo apt install -y python3 python3-pip python3-venv screen tmux curl

# إنشاء المجلد
sudo mkdir -p $BOT_DIR

# تنزيل السكريبت الرئيسي
sudo curl -fsSL $BOT_URL -o $BOT_DIR/$BOT_FILE

# تثبيت مكتبات Python
python3 -m venv $BOT_DIR/venv
source $BOT_DIR/venv/bin/activate
pip install --upgrade pip
pip install python-telegram-bot==18.2

# إعداد ملف الخدمة systemd
echo "🛠️ Creating systemd service..."
sudo tee $SERVICE_FILE > /dev/null <<EOF
[Unit]
Description=Telegram Bot Service
After=network.target

[Service]
User=root
WorkingDirectory=$BOT_DIR
ExecStart=$BOT_DIR/venv/bin/python3 $BOT_DIR/$BOT_FILE
Restart=always

[Install]
WantedBy=multi-user.target
EOF

# تفعيل الخدمة
sudo systemctl daemon-reexec
sudo systemctl enable telegram-bot
sudo systemctl restart telegram-bot

echo "✅ Bot installed and running as a service (telegram-bot)."
