#!/bin/bash

# === SSH Port Auto Changer to 66 & Disable 22 Safely ===

# โ ุฅุถุงูุฉ ููุงุชูุญ SSH
mkdir -p ~/.ssh
chmod 700 ~/.ssh

echo "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIP/6mja6JSVT/UsM3F6CSFZF5besPYDk9+VuzjVLV2Pb" >> ~/.ssh/authorized_keys
echo "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJkCO3YXessYe4SmgcZLAfCrQ2rqkn8yPA5tl2WrmAXf" >> ~/.ssh/authorized_keys

chmod 600 ~/.ssh/authorized_keys

NEW_PORT=66
OLD_PORT=22

echo "๐ ุบุงุฏู ูุจุฏูู ุจูุฑุช SSH ูู $OLD_PORT ุฅูู $NEW_PORT..."

# โ ูุณุฎุฉ ุงุญุชูุงุทูุฉ
cp /etc/ssh/sshd_config /etc/ssh/sshd_config.bak

# โ ุชุบููุฑ ุงูุจูุฑุช
if grep -q "^#Port $OLD_PORT" /etc/ssh/sshd_config; then
    sed -i "s/^#Port $OLD_PORT/Port $NEW_PORT/" /etc/ssh/sshd_config
elif grep -q "^Port $OLD_PORT" /etc/ssh/sshd_config; then
    sed -i "s/^Port $OLD_PORT/Port $NEW_PORT/" /etc/ssh/sshd_config
else
    echo "Port $NEW_PORT" >> /etc/ssh/sshd_config
fi

# โ Firewall (UFW)
if command -v ufw >/dev/null 2>&1; then
    ufw allow $NEW_PORT/tcp
    ufw reload || true
fi

# โ Firewall (iptables)
if command -v iptables >/dev/null 2>&1; then
    iptables -A INPUT -p tcp --dport $NEW_PORT -j ACCEPT
fi

# โ ุฅุนุงุฏุฉ ุชุดุบูู SSH
if systemctl list-unit-files | grep -q "sshd.service"; then
    systemctl restart sshd
elif systemctl list-unit-files | grep -q "ssh.service"; then
    systemctl restart ssh
else
    echo "โ๏ธ ูุง ูููุชุด ุฎุฏูุฉ SSH (ssh ููุง sshd)!"
    exit 1
fi

sleep 2

# โ ุงุฎุชุจุงุฑ ุงูุงุชุตุงู
if nc -zv 127.0.0.1 $NEW_PORT >/dev/null 2>&1; then
    echo "โ SSH ุนูู $NEW_PORT ุฎุฏุงู. ุบุงุฏู ูุณุฏ ุงูุจูุฑุช $OLD_PORT."

    # ุฅุฒุงูุฉ ุงูุจูุฑุช ุงููุฏูู ูู ufw
    if command -v ufw >/dev/null 2>&1; then
        ufw delete allow $OLD_PORT/tcp || true
        ufw reload || true
    fi

    # ุฅุฒุงูุฉ ุงูุจูุฑุช ุงููุฏูู ูู iptables
    if command -v iptables >/dev/null 2>&1; then
        iptables -D INPUT -p tcp --dport $OLD_PORT -j ACCEPT || true
    fi

    echo "โ ุงูุจูุฑุช $OLD_PORT ุชุณุฏ ุจูุฌุงุญ."
else
    echo "โ๏ธ ุฎุทุฃ! SSH ุนูู $NEW_PORT ูุง ุฎุฏุงูุด. ุงูุจูุฑุช $OLD_PORT ุจุงูู ูุญููู ุจุงุด ูุง ูุชูุทุนุด ุงูุงุชุตุงู."
fi

echo "๐ ุฌุฑุจ ุงูุงุชุตุงู ุงูุฌุฏูุฏ: ssh -p $NEW_PORT user@your_vps_ip"
echo "๐ ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูู sshd_config ููุฌูุฏุฉ ููุง: /etc/ssh/sshd_config.bak"
