#âœ… bot script cfg
import os
import subprocess
from telegram import (
    Update, InlineKeyboardButton, InlineKeyboardMarkup
)
from telegram.ext import (
    Application, CommandHandler, CallbackQueryHandler,
    MessageHandler, ContextTypes, filters,
    ConversationHandler
)

# =========================
# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
# =========================
TOKEN = "8323475423:AAE0tw2X0pEtf7Q0UE0dlUAFynlzY7rehBk"   # ğŸ”´ ØºÙŠØ± Ø¨Ø§Ù„ØªÙˆÙƒÙ† Ø¯ÙŠØ§Ù„Ùƒ
CHANNELS = ["@free_net_mrr", "@trusted_run", "@scr_freenet"]  
ADMINS = [7432279779]                                      
FILES_DIR = "files"
os.makedirs(FILES_DIR, exist_ok=True)

# Ù…Ù„ÙØ§Øª Ø§Ù„ØªØ®Ø²ÙŠÙ†
FILE_MAP_PATH = os.path.join(FILES_DIR, "file_map.txt")
USERS_FILE = os.path.join(FILES_DIR, "users.txt")
BLOCKED_FILE = os.path.join(FILES_DIR, "blocked.txt")

file_map = {}
USERNAME, PASSWORD = range(2)

# =========================
# Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ®Ø²ÙŠÙ†
# =========================
def load_file_map():
    global file_map
    if os.path.exists(FILE_MAP_PATH):
        with open(FILE_MAP_PATH, "r", encoding="utf-8") as f:
            for line in f:
                key, fname = line.strip().split("::", 1)
                file_map[key] = fname

def save_file_map():
    with open(FILE_MAP_PATH, "w", encoding="utf-8") as f:
        for key, fname in file_map.items():
            f.write(f"{key}::{fname}\n")

def add_user(user_id: int):
    users = set()
    if os.path.exists(USERS_FILE):
        with open(USERS_FILE, "r") as f:
            users = set(map(int, f.read().splitlines()))
    if user_id not in users:
        with open(USERS_FILE, "a") as f:
            f.write(str(user_id) + "\n")

def get_users():
    if not os.path.exists(USERS_FILE):
        return []
    with open(USERS_FILE, "r") as f:
        return [int(line.strip()) for line in f if line.strip().isdigit()]

def block_user(username: str):
    blocked = set()
    if os.path.exists(BLOCKED_FILE):
        with open(BLOCKED_FILE, "r") as f:
            blocked = set(f.read().splitlines())
    if username not in blocked:
        with open(BLOCKED_FILE, "a") as f:
            f.write(username + "\n")

def is_blocked(username: str) -> bool:
    if not os.path.exists(BLOCKED_FILE):
        return False
    with open(BLOCKED_FILE, "r") as f:
        blocked = set(f.read().splitlines())
    return username in blocked

# =========================
# Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ + Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø£Ø¯Ù…Ù†
# =========================
async def is_subscribed(user_id: int, context: ContextTypes.DEFAULT_TYPE, channel: str) -> bool:
    try:
        member = await context.bot.get_chat_member(channel, user_id)
        return member.status in ["member", "administrator", "creator"]
    except:
        return False

async def enforce_subscription(update: Update, context: ContextTypes.DEFAULT_TYPE) -> bool:
    user_id = update.effective_user.id
    username = update.effective_user.username or "Ø¨Ø¯ÙˆÙ† ÙŠÙˆØ²Ø±"
    first_name = update.effective_user.first_name or ""
    last_name = update.effective_user.last_name or ""
    fullname = (first_name + " " + last_name).strip()

    if is_blocked("@" + username):
        if update.message:
            await update.message.reply_text("ØªÙ… Ø­Ø¶Ø±Ùƒ Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª ğŸ”’")
        elif update.callback_query:
            await update.callback_query.message.reply_text("ØªÙ… Ø­Ø¶Ø±Ùƒ Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª ğŸ”’")
        return False

    for ch in CHANNELS:
        if not await is_subscribed(user_id, context, ch):
            keyboard = [
                [InlineKeyboardButton("ğŸ“¢ ÙØªØ­ Ø§Ù„Ù‚Ù†Ø§Ø©", url=f"https://t.me/{ch.strip('@')}")],
                [InlineKeyboardButton("âœ… ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ", callback_data="check_sub")]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)

            txt = (
                "âŒ| Ø¹Ø°Ø±Ø§Ù‹ Ø¹Ø²ÙŠØ²ÙŠ.\n"
                "âœ…| Ø¹Ù„ÙŠÙƒ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ù‚Ù†Ø§Ø© Ø§Ù„Ø¨ÙˆØª Ù„ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡\n\n"
                f"â¡ï¸ {ch}\n\n"
                "â€¼ï¸| Ø§Ø´ØªØ±Ùƒ Ø«Ù… Ø§Ø¶ØºØ· Ø§Ù„Ø²Ø± Ø£Ø¯Ù†Ø§Ù‡ Ø£Ùˆ Ø£Ø¹Ø¯ Ø¥Ø±Ø³Ø§Ù„ /start"
            )
            if update.message:
                await update.message.reply_text(txt, reply_markup=reply_markup)
            elif update.callback_query:
                await update.callback_query.message.reply_text(txt, reply_markup=reply_markup)
            return False

    # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… + Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø£Ø¯Ù…Ù† Ø¥Ø°Ø§ Ø¬Ø¯ÙŠØ¯
    before = set(get_users())
    add_user(user_id)
    after = set(get_users())
    if user_id not in before and user_id in after:
        total_users = len(after)
        info = (
            "ğŸ‘¤ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ Ø¯Ø®Ù„ Ù„Ù„Ø¨ÙˆØª:\n\n"
            f"ğŸ†” ID: `{user_id}`\n"
            f"ğŸ“› Ø§Ù„Ø§Ø³Ù…: {fullname}\n"
            f"ğŸ”— Ø§Ù„ÙŠÙˆØ²Ø±: @{username if username != 'Ø¨Ø¯ÙˆÙ† ÙŠÙˆØ²Ø±' else 'â€”'}\n\n"
            f"ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„ÙƒÙ„ÙŠ: {total_users}"
        )
        for admin in ADMINS:
            try:
                await context.bot.send_message(admin, info, parse_mode="Markdown")
            except:
                pass

    return True

async def check_sub(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    fake_update = Update(
        update.update_id,
        message=update.effective_message
    )
    await start(fake_update, context)
# =========================
# Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø±
# =========================
def main_menu():
    keyboard = [
        [
            InlineKeyboardButton("ğŸ“‚ Ù…Ù„Ù ÙˆÙŠÙ† 0 Ø¯Ø±Ù‡Ù… Ø§Ù†Ø¯Ø±ÙˆÙŠØ¯", callback_data="win_0_android"),
            InlineKeyboardButton("ğŸ“‚ Ù…Ù„Ù ÙˆÙŠÙ† 0 Ø¯Ø±Ù‡Ù… Ø§ÙŠÙÙˆÙ†", callback_data="win_0_ios"),
        ],
        [
            InlineKeyboardButton("ğŸ“‚ Ù…Ù„Ù Ø§ØªØµØ§Ù„Ø§Øª *6 Ø§Ù†Ø¯Ø±ÙˆÙŠØ¯", callback_data="it_6_android"),
            InlineKeyboardButton("ğŸ“‚ Ù…Ù„Ù Ø§ØªØµØ§Ù„Ø§Øª *6 Ø§ÙŠÙÙˆÙ†", callback_data="it_6_ios"),
        ],
        [
            InlineKeyboardButton("ğŸ“‚ Ù…Ù„Ù Ø§Ù†ÙˆÙŠ *6 Ø§Ù†Ø¯Ø±ÙˆÙŠØ¯", callback_data="inwi_6_android"),
            InlineKeyboardButton("ğŸ“‚ Ù…Ù„Ù Ø§Ù†ÙˆÙŠ *6 Ø§ÙŠÙÙˆÙ†", callback_data="inwi_6_ios"),
        ],
        [
            InlineKeyboardButton("âš¡ Ø§Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ SSH Ù…Ù† VPS", callback_data="ssh_account"),
        ],
    ]
    return InlineKeyboardMarkup(keyboard)

# =========================
# start command
# =========================
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not await enforce_subscription(update, context):
        return
    await update.message.reply_text(
        "âœ… Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø§Ø®ØªØ§Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©:\n@free_net_mrr",
        reply_markup=main_menu()
    )

# =========================
# Ø¥Ø±Ø³Ø§Ù„ Ø¬Ù…Ø§Ø¹ÙŠ + Ø­Ø¸Ø±
# =========================
async def send_all(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id not in ADMINS:
        return
    msg = " ".join(context.args)
    if not msg:
        await update.message.reply_text("âš ï¸ Ø§Ø³ØªØ¹Ù…Ù„: /send_all_users <Ø±Ø³Ø§Ù„Ø©>")
        return
    users = get_users()
    sent = 0
    for uid in users:
        try:
            await context.bot.send_message(uid, msg)
            sent += 1
        except:
            continue
    await update.message.reply_text(f"âœ… Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ù€ {sent} Ù…Ø³ØªØ®Ø¯Ù….")

async def block_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id not in ADMINS:
        return
    if not context.args:
        await update.message.reply_text("âš ï¸ Ø§Ø³ØªØ¹Ù…Ù„: /block_user @username")
        return
    username = context.args[0]
    block_user(username)
    await update.message.reply_text(f"â›” ØªÙ… Ø­Ø¸Ø± {username} Ø¨Ù†Ø¬Ø§Ø­.")

# =========================
# Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù…Ù„ÙØ§Øª
# =========================
async def handle_file_request(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not await enforce_subscription(update, context):
        return

    query = update.callback_query
    user_id = query.from_user.id
    file_key = query.data

    if file_key == "ssh_account":
        await query.message.reply_text("ğŸ“ Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:")
        return USERNAME
    else:
        if file_key in file_map:
            file_name = file_map[file_key]
            file_path = os.path.join(FILES_DIR, file_name)

            if os.path.exists(file_path):
                if user_id in ADMINS:
                    keyboard = [
                        [InlineKeyboardButton("ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù", callback_data=f"download_{file_key}")],
                        [InlineKeyboardButton("ğŸ”„ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…Ù„Ù", callback_data=f"replace_{file_key}")]
                    ]
                    await query.message.reply_text(
                        f"ğŸ“‚ Ø§Ù„Ù…Ù„Ù '{file_name}' Ù…ÙˆØ¬ÙˆØ¯.\nØ´Ù†Ùˆ Ø¨ØºÙŠØªÙŠ ØªØ¯ÙŠØ±ØŸ",
                        reply_markup=InlineKeyboardMarkup(keyboard)
                    )
                else:
                    await query.message.reply_document(open(file_path, "rb"), filename=file_name)
            else:
                await query.message.reply_text("âš ï¸ Ø§Ù„Ù…Ù„Ù Ø¶Ø§Ø¹ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±.")
        else:
            if user_id in ADMINS:
                await query.message.reply_text(
                    f"ğŸ“¤ Ø£Ø¯Ù…Ù† Ø§Ù„Ø¹Ø²ÙŠØ²ØŒ Ù‡Ø§Ø¯ Ø§Ù„Ù…Ù„Ù Ù…Ø§Ø²Ø§Ù„ Ù…Ø§ ÙƒØ§ÙŠÙ†Ø´.\n"
                    f"ğŸ”° Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¯Ø§Ø¨Ø§ Ø¨Ø§Ø´ ÙŠØªØ®Ø²Ù† ØªØ­Øª Ø§Ù„Ù…ÙØªØ§Ø­: {file_key}"
                )
                context.user_data["waiting_for_file"] = file_key
            else:
                await query.message.reply_text("Ù‡Ù†Ø§Ùƒ Ù…Ø´ÙƒÙ„Ø© Ø§ÙƒØªØ¨ /start Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…ÙˆØ§ØµØ© ØªØ´ØºÙŠÙ„")

# ØªØ­Ù…ÙŠÙ„ / Ø§Ø³ØªØ¨Ø¯Ø§Ù„
async def handle_replace_or_download(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user_id = query.from_user.id
    data = query.data

    if data.startswith("download_"):
        file_key = data.split("download_", 1)[1]
        if file_key in file_map:
            file_name = file_map[file_key]
            file_path = os.path.join(FILES_DIR, file_name)
            if os.path.exists(file_path):
                await query.message.reply_document(open(file_path, "rb"), filename=file_name)
            else:
                await query.message.reply_text("âš ï¸ Ø§Ù„Ù…Ù„Ù Ø¶Ø§Ø¹ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±.")
    elif data.startswith("replace_") and user_id in ADMINS:
        file_key = data.split("replace_", 1)[1]
        context.user_data["waiting_for_file"] = file_key
        await query.message.reply_text(f"â¬†ï¸ Ø£Ø±Ø³Ù„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ø§Ø´ ÙŠØªØ¨Ø¯Ù„ Ù…Ø¹ {file_key}.")

# Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
async def handle_document(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not await enforce_subscription(update, context):
        return

    user_id = update.effective_user.id
    if user_id in ADMINS and "waiting_for_file" in context.user_data:
        file_key = context.user_data.pop("waiting_for_file")

        document = update.message.document
        file_name = document.file_name
        file_path = os.path.join(FILES_DIR, file_name)

        new_file = await document.get_file()
        await new_file.download_to_drive(file_path)

        file_map[file_key] = file_name
        save_file_map()

        await update.message.reply_text(f"âœ… Ø§Ù„Ù…Ù„Ù '{file_name}' ØªØ±ÙØ¹ ÙˆØªØ¨Ø¯Ù„ Ø¨Ù†Ø¬Ø§Ø­.")
    else:
        await update.message.reply_text("â›” Ù…Ø§ Ø¹Ù†Ø¯ÙƒØ´ ØµÙ„Ø§Ø­ÙŠØ© ØªØ±ÙØ¹ Ù…Ù„ÙØ§Øª Ù‡Ù†Ø§.")

# =========================
# Ø­ÙˆØ§Ø± Ø¥Ù†Ø´Ø§Ø¡ SSH
# =========================
async def get_username(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not await enforce_subscription(update, context):
        return ConversationHandler.END
    context.user_data["username"] = update.message.text.strip()
    await update.message.reply_text("ğŸ”‘ Ø§Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:")
    return PASSWORD

async def get_password(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not await enforce_subscription(update, context):
        return ConversationHandler.END
    context.user_data["password"] = update.message.text.strip()
    user = context.user_data["username"]
    passwd = context.user_data["password"]
    expire = "3"
    iplim = "50"

    process = subprocess.Popen(
        ["/bin/bash", "/root/addssh.sh"],
        stdin=subprocess.PIPE,
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
        text=True
    )
    inputs = f"{user}\n{passwd}\n{expire}\n{iplim}\n"
    out, err = process.communicate(inputs)

    if process.returncode == 0:
        await update.message.reply_text(f"âœ… Ø§Ù„Ø­Ø³Ø§Ø¨ ØªØ®Ù„Ù‚ Ø¨Ù†Ø¬Ø§Ø­:\n\n{out}")
        for admin in ADMINS:
            try:
                await context.bot.send_message(
                    admin,
                    f"ğŸ“¢ ØªÙ… Ø§Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯:\n\n"
                    f"user: {user}\npassword: {passwd}\n"
                    f"Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: @{update.effective_user.username or update.effective_user.id}"
                )
            except:
                pass
    else:
        await update.message.reply_text(f"âš ï¸ Ø®Ø·Ø£:\n{err}")
    return ConversationHandler.END

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©")
    return ConversationHandler.END

# =========================
# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
# =========================
def main():
    load_file_map()
    app = Application.builder().token(TOKEN).build()

    conv_handler = ConversationHandler(
        entry_points=[CallbackQueryHandler(handle_file_request, pattern="^ssh_account$")],
        states={
            USERNAME: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_username)],
            PASSWORD: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_password)],
        },
        fallbacks=[CommandHandler("cancel", cancel)],
    )

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("send_all_users", send_all))
    app.add_handler(CommandHandler("block_user", block_cmd))
    app.add_handler(conv_handler)
    app.add_handler(CallbackQueryHandler(handle_file_request))
    app.add_handler(CallbackQueryHandler(handle_replace_or_download, pattern="^(replace_|download_).*$"))
    app.add_handler(CallbackQueryHandler(check_sub, pattern="^check_sub$"))
    app.add_handler(MessageHandler(filters.Document.ALL, handle_document))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, start))

    print("ğŸš€ Ø§Ù„Ø¨ÙˆØª Ø®Ø¯Ø§Ù… Ø¯Ø§Ø¨Ø§...")
    app.run_polling()

if __name__ == "__main__":
    main()
